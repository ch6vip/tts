<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TTS Â· é«˜å“è´¨æ–‡æœ¬è½¬è¯­éŸ³</title>
    <script src="{{.BasePath}}/static/js/tailwind.js"></script>
    <link rel="icon" type="image/svg+xml" href="{{.BasePath}}/static/icons/favicon.svg">
    <meta name="description" content="ä¸€ä¸ªä¸“ä¸šã€æ˜“ç”¨çš„åœ¨çº¿æ–‡æœ¬è½¬è¯­éŸ³ï¼ˆTTSï¼‰æœåŠ¡ï¼Œæä¾›é«˜è´¨é‡çš„è¯­éŸ³åˆæˆèƒ½åŠ›ã€‚">
    <script src="{{.BasePath}}/static/js/app.js"></script>
    <style>
        /* Google Fonts (å¯é€‰ï¼Œæä¾›æ›´å¥½çš„å­—ä½“æ•ˆæœ) */
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+SC:wght@400;500;700&display=swap');

        body {
            font-family: 'Noto Sans SC', sans-serif;
            background-color: #0d1117; /* æ·±é‚ƒçš„èƒŒæ™¯è‰² */
            color: #c9d1d9;
        }

        /* è¾‰å…‰èƒŒæ™¯æ•ˆæœ */
        .glow-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            overflow: hidden;
            z-index: -1;
        }
        .glow-container::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 800px;
            height: 800px;
            transform: translate(-50%, -50%);
            background: radial-gradient(circle, rgba(29, 78, 216, 0.15) 0%, rgba(29, 78, 216, 0) 70%);
            animation: pulse 10s infinite;
        }

        @keyframes pulse {
            0%, 100% { transform: translate(-50%, -50%) scale(0.8); opacity: 0.8; }
            50% { transform: translate(-50%, -50%) scale(1.2); opacity: 1; }
        }

        /* å¡ç‰‡æ ·å¼ */
        .card {
            background: rgba(22, 27, 34, 0.8);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid #30363d;
            transition: all 0.3s ease;
        }

        /* è¾“å…¥æ¡†ã€é€‰æ‹©æ¡†æ ·å¼ */
        .form-input {
            background-color: #0d1117;
            border-color: #30363d;
            color: #c9d1d9;
            transition: all 0.2s ease;
        }
        .form-input:focus {
            outline: none;
            border-color: #2f81f7;
            box-shadow: 0 0 0 3px rgba(47, 129, 247, 0.3);
        }
        select option {
            background-color: #161b22;
            color: #c9d1d9;
        }

        /* ä¸»æŒ‰é’®æ ·å¼ */
        .btn-primary {
            background: #238636;
            border: 1px solid rgba(240, 246, 252, 0.1);
            box-shadow: 0 1px 0 rgba(240, 246, 252, 0.04) inset, 0 1px 0 rgba(0, 0, 0, 0.15);
        }
        .btn-primary:hover {
            background: #2ea043;
        }
        .btn-primary:disabled {
            background: #30363d;
            cursor: not-allowed;
        }

        /* æ¬¡è¦æŒ‰é’®æ ·å¼ */
        .btn-secondary {
            background-color: #21262d;
            border: 1px solid #30363d;
        }
        .btn-secondary:hover {
            background-color: #30363d;
            border-color: #8b949e;
        }

        /* æ»‘å—æ ·å¼ */
        input[type="range"] {
            -webkit-appearance: none; appearance: none;
            height: 6px; background: #30363d; border-radius: 3px;
        }
        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none; appearance: none;
            width: 18px; height: 18px; border-radius: 50%; background: #c9d1d9; cursor: pointer;
            transition: background 0.2s ease;
        }
        input[type="range"]::-webkit-slider-thumb:hover { background: #fff; }
        input[type="range"]::-moz-range-thumb {
            width: 18px; height: 18px; border-radius: 50%; background: #c9d1d9; cursor: pointer; border: none;
            transition: background 0.2s ease;
        }
        input[type="range"]::-moz-range-thumb:hover { background: #fff; }
        
        /* è‡ªå®šä¹‰éŸ³é¢‘æ’­æ”¾å™¨æ ·å¼ */
        audio {
            filter: invert(1) hue-rotate(180deg) contrast(0.8);
        }

        /* åŠ è½½ä¸­åŠ¨ç”» */
        .loader {
            width: 1.25rem;
            height: 1.25rem;
            border: 2px solid currentColor;
            border-bottom-color: transparent;
            border-radius: 50%;
            display: inline-block;
            box-sizing: border-box;
            animation: rotation 1s linear infinite;
        }
        @keyframes rotation {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>

<body class="min-h-screen">
    <div class="glow-container"></div>
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-12">

        <header class="text-center mb-12">
            <h1 class="text-4xl sm:text-5xl lg:text-6xl font-bold tracking-tight text-white">
                TTS è¯­éŸ³åˆæˆå¼•æ“
            </h1>
            <p class="mt-4 max-w-2xl mx-auto text-lg text-gray-400">
                å°†æ–‡æœ¬è½¬åŒ–ä¸ºç”ŸåŠ¨ã€è‡ªç„¶çš„äººå£°ï¼Œæ”¯æŒå¤šç§å£°éŸ³ä¸æƒ…æ„Ÿé£æ ¼ã€‚
            </p>
        </header>

        <div class="grid grid-cols-1 lg:grid-cols-5 gap-8">
            
            <div class="lg:col-span-3">
                <div class="card p-6 sm:p-8 rounded-xl">
                    <div class="mb-6">
                        <div class="flex justify-between items-center mb-2">
                            <label for="text" class="block text-sm font-medium text-gray-400">è¾“å…¥å†…å®¹</label>
                            <div class="flex items-center gap-2">
                                <label class="text-xs text-gray-500">è¾“å…¥æ¨¡å¼:</label>
                                <button id="toggleInputMode" class="btn-secondary px-3 py-1 text-xs rounded">æ–‡æœ¬æ¨¡å¼</button>
                            </div>
                        </div>
                        <div class="relative">
                            <textarea id="text" rows="10" class="form-input w-full p-3 rounded-md shadow-sm text-base" placeholder="åœ¨æ­¤è¾“å…¥éœ€è¦è½¬æ¢çš„æ–‡æœ¬..."></textarea>
                            <textarea id="ssml" rows="10" class="form-input w-full p-3 rounded-md shadow-sm text-base hidden" placeholder="åœ¨æ­¤è¾“å…¥ SSML å†…å®¹...&#10;&#10;ç¤ºä¾‹:&#10;<speak>&#10;  <voice name='zh-CN-XiaoxiaoNeural'>&#10;    ä½ å¥½ï¼Œ<prosody rate='slow'>è¿™æ˜¯æ…¢é€Ÿè¯­éŸ³</prosody>ï¼Œ&#10;    <prosody pitch='high'>è¿™æ˜¯é«˜éŸ³è°ƒ</prosody>ã€‚&#10;  </voice>&#10;</speak>"></textarea>
                            <div class="absolute bottom-3 right-3 text-xs text-gray-500">
                                <span id="charCount">0</span> / 5000
                            </div>
                        </div>
                        <div id="ssmlHelp" class="hidden mt-2 text-xs text-gray-500">
                            <p class="mb-1">ğŸ’¡ SSML æç¤ºï¼š</p>
                            <ul class="list-disc list-inside space-y-1">
                                <li>ä½¿ç”¨ &lt;prosody rate="..."&gt; è°ƒæ•´è¯­é€Ÿï¼ˆx-slow, slow, medium, fast, x-fastï¼‰</li>
                                <li>ä½¿ç”¨ &lt;prosody pitch="..."&gt; è°ƒæ•´éŸ³è°ƒï¼ˆx-low, low, medium, high, x-highï¼‰</li>
                                <li>ä½¿ç”¨ &lt;break time="..."&gt; æ·»åŠ åœé¡¿ï¼ˆå¦‚ 500ms æˆ– 1sï¼‰</li>
                                <li>ä½¿ç”¨ &lt;emphasis level="..."&gt; å¼ºè°ƒæ–‡æœ¬ï¼ˆstrong, moderate, reducedï¼‰</li>
                            </ul>
                        </div>
                    </div>

                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-6 mb-6">
                        <div>
                            <label for="voice" class="block text-sm font-medium text-gray-400 mb-2">é€‰æ‹©å£°éŸ³</label>
                            <select id="voice" class="form-input w-full p-2.5 rounded-md">
                                <option value="loading">åŠ è½½ä¸­...</option>
                            </select>
                        </div>
                        <div>
                            <label for="style" class="block text-sm font-medium text-gray-400 mb-2">æƒ…æ„Ÿé£æ ¼</label>
                            <select id="style" class="form-input w-full p-2.5 rounded-md">
                                <option value="general">æ™®é€š</option>
                            </select>
                        </div>
                    </div>

                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-6 mb-8">
                        <div>
                            <label for="rate" class="block text-sm font-medium text-gray-400">è¯­é€Ÿ</label>
                            <div class="flex items-center mt-2">
                                <input type="range" id="rate" min="-100" max="100" value="{{.DefaultRate}}" class="w-full">
                                <span id="rateValue" class="ml-4 w-12 text-center text-sm text-gray-400">{{.DefaultRate}}%</span>
                            </div>
                        </div>
                        <div>
                            <label for="pitch" class="block text-sm font-medium text-gray-400">è¯­è°ƒ</label>
                            <div class="flex items-center mt-2">
                                <input type="range" id="pitch" min="-100" max="100" value="{{.DefaultPitch}}" class="w-full">
                                <span id="pitchValue" class="ml-4 w-12 text-center text-sm text-gray-400">{{.DefaultPitch}}%</span>
                            </div>
                        </div>
                    </div>

                    <button id="speak" class="btn-primary w-full flex items-center justify-center gap-x-3 py-3 text-base font-semibold rounded-md transition-all">
                        <svg class="w-5 h-5" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M7 17H5a2 2 0 0 1-2-2V9a2 2 0 0 1 2-2h2v10Zm2 2h2a1 1 0 0 0 1-1v-1a1 1 0 0 0-1-1h-2a1 1 0 0 0-1 1v1a1 1 0 0 0 1 1Zm10.298-9.942a1 1 0 0 0-1.09.218L15 13.11V4a1 1 0 0 0-2 0v2.11l-3.21-3.832a1 1 0 0 0-1.58.125l-2.4 4A1 1 0 0 0 7 8h2a1 1 0 0 0 .89-.55l1.6-2.667 3.01 3.613a1 1 0 0 0 .8.4H17a1 1 0 0 0 .89-1.447l-1.6-2.666 1.708-2.05a1 1 0 0 0-1.12-1.664L14 7.234V9a1 1 0 0 0 2 0v-2.11l1.298-1.557a1 1 0 0 0 .22-1.09l-.7-1.226a1 1 0 0 0-1.366-.363L12 5.11V4a1 1 0 1 0-2 0v1.11L6.79.278a1 1 0 0 0-1.09-.218l-2.4 1.2a1 1 0 0 0-.472 1.366L6.29 9.308a1 1 0 0 0 1.366.472l.7-.35-1.92 3.2a1 1 0 0 0 .89 1.447H9v3a1 1 0 0 0 2 0v-3.11l1.79 2.148a1 1 0 0 0 1.58-.125l2.4-4a1 1 0 0 0-.22-1.31zM19.5 21a1.5 1.5 0 1 0 0-3 1.5 1.5 0 0 0 0 3z"/></svg>
                        <span>ç«‹å³åˆæˆ</span>
                    </button>
                </div>
            </div>

            <div class="lg:col-span-2 space-y-8">
                <div id="resultSection" class="card p-6 sm:p-8 rounded-xl hidden">
                    <h3 class="text-xl font-semibold text-white mb-4">åˆæˆç»“æœ</h3>
                    <div class="space-y-4">
                        <audio id="audioPlayer" controls class="w-full"></audio>
                        <div class="grid grid-cols-2 sm:grid-cols-2 gap-3">
                            <button id="download" class="btn-secondary flex items-center justify-center gap-x-2 py-2 rounded-md">ä¸‹è½½éŸ³é¢‘</button>
                            <button id="copyLink" class="btn-secondary flex items-center justify-center gap-x-2 py-2 rounded-md">å¤åˆ¶é“¾æ¥</button>
                            <button id="copyHttpTtsLink" class="btn-secondary flex items-center justify-center gap-x-2 py-2 rounded-md">å¯¼å…¥ã€Œé˜…è¯»ã€</button>
                            <button id="copyIfreetimeLink" class="btn-secondary flex items-center justify-center gap-x-2 py-2 rounded-md">å¯¼å…¥ã€Œçˆ±é˜…è®°ã€</button>
                        </div>
                    </div>
                </div>

                <div class="card p-6 sm:p-8 rounded-xl">
                    <h3 class="text-xl font-semibold text-white mb-4">API å¯†é’¥</h3>
                    <p class="text-sm text-gray-400 mb-4">éƒ¨åˆ†åŠŸèƒ½éœ€è¦ API å¯†é’¥æ‰èƒ½ä½¿ç”¨ã€‚å¯†é’¥å°†å®‰å…¨åœ°å­˜å‚¨åœ¨æ‚¨çš„æµè§ˆå™¨ä¸­ã€‚</p>
                    <div id="api-key-group">
                        <div class="relative">
                            <input type="password" id="api-key" placeholder="åœ¨æ­¤è¾“å…¥æ‚¨çš„ API Key" class="form-input w-full p-2.5 pr-10 rounded-md">
                            <button id="toggle-password" class="absolute inset-y-0 right-0 px-3 flex items-center text-gray-500 hover:text-gray-300">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path d="M10 12a2 2 0 100-4 2 2 0 000 4z" /><path fill-rule="evenodd" d="M.458 10C1.732 5.943 5.522 3 10 3s8.268 2.943 9.542 7c-1.274 4.057-5.064 7-9.542 7S1.732 14.057.458 10zM14 10a4 4 0 11-8 0 4 4 0 018 0z" clip-rule="evenodd" /></svg>
                            </button>
                        </div>
                        <div class="flex justify-end mt-3">
                            <button onclick="saveApiKey()" class="btn-secondary px-4 py-2 text-sm font-medium rounded-md">ä¿å­˜å¯†é’¥</button>
                        </div>
                         <p id="api-key-status" class="text-xs text-green-400 mt-2 hidden">API Key å·²ä¿å­˜</p>
                    </div>
                </div>
            </div>
        </div>
        
        <footer class="text-center mt-16">
            <a href="{{.BasePath}}/api-doc" class="text-sm text-gray-500 hover:text-gray-400 transition">API æ–‡æ¡£</a>
            <span class="text-gray-600 mx-2">&middot;</span>
            <p class="inline text-sm text-gray-500">&copy; 2025 TTS æœåŠ¡</p>
        </footer>

    </div>

    <div id="custom-alert-container"></div>

    <script>
        // å…¨å±€é…ç½®ï¼Œç”±Goæ¨¡æ¿æ³¨å…¥
        const config = {
            basePath: "{{.BasePath}}",
            defaultVoice: "{{.DefaultVoice}}",
            defaultRate: "{{.DefaultRate}}",
            defaultPitch: "{{.DefaultPitch}}",
            defaultStyle: ""
        };

        // SSML æ¨¡å¼åˆ‡æ¢åŠŸèƒ½
        let isSSMLMode = false;

        // æŒ‰é’®åŠ è½½çŠ¶æ€å¤„ç†
        document.addEventListener('DOMContentLoaded', () => {
            // SSML æ¨¡å¼åˆ‡æ¢
            const toggleInputModeBtn = document.getElementById('toggleInputMode');
            const textInput = document.getElementById('text');
            const ssmlInput = document.getElementById('ssml');
            const ssmlHelp = document.getElementById('ssmlHelp');
            
            if (toggleInputModeBtn) {
                toggleInputModeBtn.addEventListener('click', () => {
                    isSSMLMode = !isSSMLMode;
                    
                    if (isSSMLMode) {
                        textInput.classList.add('hidden');
                        ssmlInput.classList.remove('hidden');
                        ssmlHelp.classList.remove('hidden');
                        toggleInputModeBtn.textContent = 'SSMLæ¨¡å¼';
                    } else {
                        textInput.classList.remove('hidden');
                        ssmlInput.classList.add('hidden');
                        ssmlHelp.classList.add('hidden');
                        toggleInputModeBtn.textContent = 'æ–‡æœ¬æ¨¡å¼';
                    }
                });
            }

            // æ›´æ–°å­—ç¬¦è®¡æ•°
            const updateCharCount = () => {
                const count = isSSMLMode ? ssmlInput.value.length : textInput.value.length;
                document.getElementById('charCount').textContent = count;
            };
            
            textInput.addEventListener('input', updateCharCount);
            ssmlInput.addEventListener('input', updateCharCount);
            const speakButton = document.getElementById('speak');
            const originalButtonContent = speakButton.innerHTML;

            // é‡æ–°å®šä¹‰ä¸€ä¸ªå‡½æ•°æ¥æ”¹å˜æŒ‰é’®çŠ¶æ€ï¼Œé¿å…ä¸app.jså†²çª
            window.setButtonLoading = (isLoading) => {
                if (isLoading) {
                    speakButton.disabled = true;
                    speakButton.innerHTML = `<span class="loader"></span><span>æ­£åœ¨åˆæˆ...</span>`;
                } else {
                    speakButton.disabled = false;
                    speakButton.innerHTML = originalButtonContent;
                }
            };
            
            // è¦†ç›–åŸæœ‰çš„ç”Ÿæˆè¯­éŸ³å‡½æ•°ï¼Œä»¥é›†æˆåŠ è½½çŠ¶æ€
            const originalGenerateSpeech = window.generateSpeech; // å‡è®¾app.jsä¸­æ˜¯å…¨å±€å‡½æ•°
            window.generateSpeech = async function() {
                setButtonLoading(true);
                try {
                    // å‡è®¾app.jsä¸­çš„å®ç°æ˜¯å¼‚æ­¥çš„
                    await originalGenerateSpeech(); 
                } catch (e) {
                    console.error("ç”Ÿæˆå¤±è´¥:", e);
                } finally {
                    setButtonLoading(false);
                }
            };

            // å¦‚æœapp.jsæ˜¯é€šè¿‡äº‹ä»¶ç›‘å¬å™¨ç»‘å®šçš„ï¼Œæˆ‘ä»¬éœ€è¦è°ƒæ•´
            speakButton.addEventListener('click', async (event) => {
                event.stopImmediatePropagation(); // é˜»æ­¢app.jsä¸­çš„ç›‘å¬å™¨æ‰§è¡Œ
                setButtonLoading(true);
                try {
                    // è¿™é‡Œéœ€è¦å¤åˆ¶app.jsä¸­çš„æ ¸å¿ƒé€»è¾‘
                    const textInput = document.getElementById('text');
                    const ssmlInput = document.getElementById('ssml');
                    const voiceSelect = document.getElementById('voice');
                    const styleSelect = document.getElementById('style');
                    const rateInput = document.getElementById('rate');
                    const pitchInput = document.getElementById('pitch');
                    const apiKeyInput = document.getElementById('api-key');

                    // æ ¹æ®æ¨¡å¼è·å–è¾“å…¥å†…å®¹
                    const inputText = isSSMLMode ? ssmlInput.value.trim() : textInput.value.trim();
                    if (!inputText) {
                        showCustomAlert(isSSMLMode ? 'è¯·è¾“å…¥ SSML å†…å®¹' : 'è¯·è¾“å…¥è¦è½¬æ¢çš„æ–‡æœ¬', 'warning');
                        return;
                    }

                    const apiKey = apiKeyInput.value.trim() || localStorage.getItem('apiKey');
                    const params = new URLSearchParams();
                    
                    // æ ¹æ®æ¨¡å¼è®¾ç½®å‚æ•°
                    if (isSSMLMode) {
                        params.append('ssml', inputText);
                    } else {
                        params.append('t', inputText);
                        params.append('v', voiceSelect.value);
                        params.append('r', rateInput.value);
                        params.append('p', pitchInput.value);
                        params.append('s', styleSelect.value);
                    }

                    if (apiKey) {
                        params.append('api_key', apiKey);
                    }

                    const url = `${config.basePath}/tts?${params.toString()}`;
                    const response = await fetch(url);

                    if (!response.ok) {
                       const errorData = await response.json().catch(() => ({error: `HTTP é”™è¯¯: ${response.status}`}));
                       showCustomAlert(errorData.error || 'åˆæˆå¤±è´¥', 'error');
                       return;
                    }
                    
                    const blob = await response.blob();
                    const audioUrl = URL.createObjectURL(blob);
                    
                    const audioPlayer = document.getElementById('audioPlayer');
                    audioPlayer.src = audioUrl;
                    audioPlayer.play();

                    const resultSection = document.getElementById('resultSection');
                    resultSection.classList.remove('hidden');

                    // èµ‹å€¼ç»™å…¨å±€å˜é‡ä»¥ä¾›å…¶ä»–æŒ‰é’®ä½¿ç”¨
                    window.lastAudioUrl = url; 
                    
                } catch (e) {
                    console.error("ç”Ÿæˆå¤±è´¥:", e);
                    showCustomAlert('å‘ç”Ÿç½‘ç»œé”™è¯¯ï¼Œè¯·ç¨åé‡è¯•ã€‚', 'error');
                } finally {
                    setButtonLoading(false);
                }
            }, true); // ä½¿ç”¨æ•è·é˜¶æ®µä¼˜å…ˆæ‰§è¡Œ

        });
    </script>
</body>
</html>